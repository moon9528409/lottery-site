<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æŠ½çæŸ¥è©¢ (v3)</title>
<style>
  body{font-family:"Microsoft JhengHei",sans-serif;margin:0;background:linear-gradient(135deg,#c9d6ff,#e2e2e2);color:#222}
  header{background:linear-gradient(135deg,#3f51b5,#5c6bc0);color:#fff;padding:16px;text-align:center}
  .container{max-width:980px;margin:20px auto;padding:16px}
  .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:16px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:center}
  th{background:#f5f7ff;color:#263238}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:#3f51b5;color:#fff;cursor:pointer;margin:4px}
  .btn:active{transform:translateY(1px)}
  .search{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .search input{padding:8px;border-radius:8px;border:1px solid #ddd;width:60%}
  #historyList{max-height:240px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px;background:#fafafa}
  .hidden{display:none}
  @media(max-width:640px){ .search input{width:100%} th,td{font-size:14px;padding:8px} }
</style>
</head>
<body>
<header><h1>ä½³å†¬é„‰ä¸­ç§‹æ™šæœƒ â€” æŠ½çæŸ¥è©¢ v3</h1></header>
<div class="container">
  <div class="card">
    <div class="search">
      <input id="searchInput" placeholder="æœå°‹ï¼šä¸­çè™Ÿç¢¼ / æ‘¸å½©å“ / å¾—çäºº / é›»è©±ï¼ŒæŒ‰ Enter æœå°‹" onkeydown="if(event.key==='Enter') searchItems()">
      <button class="btn" onclick="searchItems()">æœå°‹</button>
      <button class="btn" onclick="clearSearch()">æ¸…é™¤</button>
      <button class="btn" onclick="manualRefresh()">é‡æ–°è¼‰å…¥</button>
    </div>
    <div id="searchCount" style="text-align:center;color:#555;margin-bottom:8px"></div>
    <table id="lotteryTable">
      <thead>
        <tr><th>ä¸­çè™Ÿç¢¼</th><th>æ‘¸å½©å“</th><th>å¾—çäºº</th><th>é›»è©±</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card hidden" id="editCard">
    <h3>ç·¨è¼¯æ¨¡å¼ï¼ˆå—ä¿è­·ï¼‰</h3>
    <div style="margin-bottom:8px">
      <button class="btn" onclick="addRow()">æ–°å¢ä¸€ç­†</button>
      <button class="btn" onclick="saveData()">å„²å­˜ä¸¦åŒæ­¥</button>
      <button class="btn" onclick="showHistory()">æŸ¥çœ‹æ­·å²ç´€éŒ„</button>
    </div>
    <div id="historyList" class="hidden"></div>
  </div>

  <div style="text-align:center;margin-top:6px">
    <button class="btn" onclick="toggleMode()">åˆ‡æ›ç·¨è¼¯/è§€çœ‹æ¨¡å¼</button>
  </div>
</div>

<footer style="text-align:center;padding:12px;background:#3f51b5;color:#fff;">ğŸŒ• ä½³å†¬é„‰ä¸­ç§‹æ™šæœƒæ´»å‹• | æ°´è³‡æºå®£å° ğŸŒŠ</footer>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ---- Firebase config (already provided) ----
const firebaseConfig = {
  apiKey: "AIzaSyCTLCfy-ZXDHf-0yJJNVY9ySC6js77VvEI",
  authDomain: "lottery-737ad.firebaseapp.com",
  databaseURL: "https://lottery-737ad-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lottery-737ad",
  storageBucket: "lottery-737ad.firebasestorage.app",
  messagingSenderId: "359372602155",
  appId: "1:359372602155:web:ffc53d2494a3cb89a6236e",
  measurementId: "G-L73KVZTMVT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---- state ----
let editMode = false;
const EDIT_PASSWORD = "900226";

// Toggle edit mode (requires password)
function toggleMode(){
  if(!editMode){
    const input = prompt("è«‹è¼¸å…¥ç·¨è¼¯å¯†ç¢¼ï¼š");
    if(input === EDIT_PASSWORD){
      editMode = true;
      document.getElementById("editCard").classList.remove("hidden");
      makeTableEditable(true);
    } else {
      alert("å¯†ç¢¼éŒ¯èª¤ï¼");
    }
  } else {
    editMode = false;
    document.getElementById("editCard").classList.add("hidden");
    document.getElementById("historyList").classList.add("hidden");
    makeTableEditable(false);
  }
}

function makeTableEditable(enable){
  document.querySelectorAll("#lotteryTable td").forEach(td=>{
    td.contentEditable = enable;
    td.style.background = enable ? "#fffde7" : "";
  });
}

// Add a new editable row
function addRow(){
  const tbody = document.querySelector("#lotteryTable tbody");
  const row = tbody.insertRow();
  const cells = ["æ–°ä¸­çè™Ÿ","æ–°çå“","æ–°å¾—çäºº","æ–°é›»è©±"];
  cells.forEach(txt=>{
    const c = row.insertCell();
    c.innerText = txt;
    c.contentEditable = true;
    c.style.background = "#fffde7";
  });
}

// Save current table => write to Firebase current and push to history
function saveData(){
  const data=[];
  document.querySelectorAll("#lotteryTable tbody tr").forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    data.push({
      number: (tds[0]?.innerText||"").trim(),
      item: (tds[1]?.innerText||"").trim(),
      winner: (tds[2]?.innerText||"").trim(),
      phone: (tds[3]?.innerText||"").trim()
    });
  });
  const timestamp = Date.now();
  // write current
  db.ref("/lottery/current").set({time: timestamp, data: data})
    .then(()=>{
      // push history
      db.ref("/lottery/history").push({time: timestamp, data: data});
      alert("å·²å„²å­˜ä¸¦åŒæ­¥åˆ° Firebaseï¼");
      clearSearch();
    }).catch(err=>{
      console.error(err);
      alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®šã€‚");
    });
}

// Show history list (reads last 50 entries)
function showHistory(){
  const listEl = document.getElementById("historyList");
  listEl.innerHTML = "";
  db.ref("/lottery/history").limitToLast(50).once("value").then(snap=>{
    const val = snap.val();
    if(!val){ alert("æ²’æœ‰æ­·å²ç´€éŒ„"); return; }
    const arr = Object.keys(val).map(k=>({key:k, v: val[k]})).sort((a,b)=>b.v.time - a.v.time);
    arr.forEach(entry => {
      const d = new Date(entry.v.time);
      const div = document.createElement("div");
      div.style.padding="8px";
      div.style.borderBottom="1px solid #eee";
      div.style.cursor="pointer";
      div.innerText = `${d.toLocaleString()} â€” ${entry.v.data.length} ç­†`;
      div.onclick = ()=> loadHistory(entry.v);
      listEl.appendChild(div);
    });
    listEl.classList.remove("hidden");
  }).catch(err=>{ console.error(err); alert("è®€å–æ­·å²å¤±æ•—"); });
}

// Load a specific historical snapshot into table
function loadHistory(h){
  const tbody = document.querySelector("#lotteryTable tbody");
  tbody.innerHTML = "";
  (h.data||[]).forEach(r=>{
    const row = tbody.insertRow();
    row.insertCell().innerText = r.number || "";
    row.insertCell().innerText = r.item || "";
    row.insertCell().innerText = r.winner || "";
    row.insertCell().innerText = r.phone || "";
  });
  alert(`å·²è¼‰å…¥ ${new Date(h.time).toLocaleString()} çš„è³‡æ–™`);
  clearSearch();
}

// Render table from data array
function renderTableFromData(data){
  const tbody = document.querySelector("#lotteryTable tbody");
  tbody.innerHTML = "";
  (data||[]).forEach(r=>{
    const row = tbody.insertRow();
    row.insertCell().innerText = r.number || "";
    row.insertCell().innerText = r.item || "";
    row.insertCell().innerText = r.winner || "";
    row.insertCell().innerText = r.phone || "";
  });
}

// Search items (partial, case-insensitive) and highlight rows
function searchItems(){
  const q = (document.getElementById("searchInput").value||"").trim().toLowerCase();
  const rows = Array.from(document.querySelectorAll("#lotteryTable tbody tr"));
  let matches = 0;
  rows.forEach(r=> r.classList.remove("highlight"));
  if(q===""){
    document.getElementById("searchCount").innerText = "";
    // show all
    rows.forEach(r=> r.style.display = "");
    return;
  }
  rows.forEach(r=>{
    const text = r.innerText.toLowerCase();
    if(text.includes(q)){
      r.style.display = "";
      r.classList.add("highlight");
      matches++;
    } else {
      r.style.display = "none";
    }
  });
  document.getElementById("searchCount").innerText = `æœå°‹ã€Œ${q}ã€çµæœï¼š ${matches} ç­†`;
  if(matches>0){
    const first = document.querySelector("#lotteryTable tbody tr:not([style*='display: none'])");
    if(first) first.scrollIntoView({behavior:"smooth", block:"center"});
  } else {
    // no match alert but not disruptive
    // alert("æŸ¥ç„¡çµæœ");
  }
}

// Clear search
function clearSearch(){
  document.getElementById("searchInput").value = "";
  document.getElementById("searchCount").innerText = "";
  document.querySelectorAll("#lotteryTable tbody tr").forEach(r=>{ r.style.display=""; r.classList.remove("highlight"); });
}

// Manual refresh: fetch current snapshot once
function manualRefresh(){
  db.ref("/lottery/current").once("value").then(snap=>{
    const v = snap.val();
    if(v && v.data) renderTableFromData(v.data);
    clearSearch();
  });
}

// Attach realtime listener to always show latest
db.ref("/lottery/current").on("value", snap=>{
  const v = snap.val();
  if(v && v.data) renderTableFromData(v.data);
});

// On load, try to fetch current once
window.onload = function(){ manualRefresh(); };
</script>
</body>
</html>
