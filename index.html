
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä½³å†¬é„‰çæƒœæ°´è³‡æºå®£å°æš¨ä¸­ç§‹æ™šæœƒæ´»å‹• ğŸ‰ æŠ½çæŸ¥è©¢ï¼ˆå¯ç·¨è¼¯ï¼‰</title>
<style>
  body{font-family:"Microsoft JhengHei",sans-serif;margin:0;background:linear-gradient(135deg,#c9d6ff,#e2e2e2);color:#222}
  header{background:linear-gradient(135deg,#3f51b5,#5c6bc0);color:#fff;padding:16px;text-align:center}
  .container{max-width:980px;margin:20px auto;padding:16px}
  .warningBox{
    background:#fff;
    color:#d32f2f;
    border:2px solid #d32f2f;
    border-radius:8px;
    padding:12px;
    font-weight:bold;
    text-align:center;
    margin:16px 0;
  }
  .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:16px}
  .table-wrapper{overflow-x:auto}
  table{width:100%;border-collapse:collapse;min-width:620px}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:center;vertical-align:middle}
  th{background:#f5f7ff;color:#263238}
  .btn{padding:8px 12px;border-radius:8px;border:0;background:#3f51b5;color:#fff;cursor:pointer;margin:4px}
  .btn.red{background:#d32f2f}
  .search{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .search input{padding:8px;border-radius:8px;border:1px solid #ddd;width:60%}
  #historyList{max-height:240px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px;background:#fafafa}
  .hidden{display:none}
  .highlight{background:#fff9c4}
  @media(max-width:640px){ .search input{width:100%} th,td{font-size:14px;padding:8px} }
  .note{margin-top:8px;color:#b71c1c;font-weight:bold;text-align:center}
  .small{font-size:13px;color:#666}
</style>
</head>
<body>
<header>
  <h1>ä½³å†¬é„‰çæƒœæ°´è³‡æºå®£å°æš¨ä¸­ç§‹æ™šæœƒæ´»å‹• ğŸ‰ æŠ½çæŸ¥è©¢ï¼ˆå¯ç·¨è¼¯ï¼‰</h1>
</header>

<div class="container">
  <div class="warningBox" id="timeNotice">
    æŸ¥è©¢é–‹æ”¾æ™‚é–“ï¼š2025/09/28 17:00 ~ 23:30ã€€|ã€€çé …éœ€æ–¼æ™šæœƒæ´»å‹•æœŸé–“é ˜å–ï¼Œæ´»å‹•çµæŸå¾Œä¸è£œé ˜
  </div>

  <div class="card">
    <div class="search">
      <input id="searchInput" placeholder="æœå°‹ï¼šä¸­çè™Ÿç¢¼ / æ‘¸å½©å“ / å¾—çäºº / é›»è©±ï¼ŒæŒ‰ Enter æœå°‹" onkeydown="if(event.key==='Enter') searchItems()">
      <button class="btn" onclick="searchItems()">æœå°‹</button>
      <button class="btn" onclick="clearSearch()">æ¸…é™¤</button>
      <button class="btn" onclick="manualRefresh()">é‡æ–°è¼‰å…¥</button>
    </div>
    <div id="searchCount" style="text-align:center;color:#555;margin-bottom:8px"></div>
    <div class="table-wrapper">
      <table id="lotteryTable">
        <thead>
          <tr><th>ä¸­çè™Ÿç¢¼</th><th>æ‘¸å½©å“</th><th>å¾—çäºº</th><th>é›»è©±</th><th class="adminCol hidden">æ“ä½œ</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="small" style="text-align:center;margin-top:8px">è¨ªå®¢å¯åœ¨é–‹æ”¾æ™‚é–“æŸ¥è©¢ï¼›ç®¡ç†å“¡ç™»å…¥å¾Œä¸å—æ™‚é–“é™åˆ¶ä¸¦å¯ç·¨è¼¯ï¼åˆªé™¤ã€‚</div>
  </div>

  <div class="card hidden" id="editCard">
    <h3>ç·¨è¼¯æ¨¡å¼ï¼ˆç®¡ç†å“¡ï¼‰</h3>
    <div style="margin-bottom:8px">
      <button class="btn" onclick="addRow()">æ–°å¢ä¸€ç­†</button>
      <button class="btn" onclick="saveData()">å„²å­˜ä¸¦åŒæ­¥</button>
      <button class="btn" onclick="showHistory()">æŸ¥çœ‹æ­·å²ç´€éŒ„</button>
    </div>
    <div id="historyList" class="hidden"></div>
  </div>

  <div style="text-align:center;margin-top:6px">
    <button class="btn" onclick="toggleMode()">åˆ‡æ›ç·¨è¼¯/è§€çœ‹æ¨¡å¼</button>
  </div>
</div>

<footer style="text-align:center;padding:12px;background:#3f51b5;color:#fff;">ğŸŒ• ä½³å†¬é„‰ä¸­ç§‹æ™šæœƒæ´»å‹• | æ°´è³‡æºå®£å° ğŸŒŠ</footer>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase config (replace if needed)
const firebaseConfig = {
  apiKey: "AIzaSyCTLCfy-ZXDHf-0yJJNVY9ySC6js77VvEI",
  authDomain: "lottery-737ad.firebaseapp.com",
  databaseURL: "https://lottery-737ad-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lottery-737ad",
  storageBucket: "lottery-737ad.firebasestorage.app",
  messagingSenderId: "359372602155",
  appId: "1:359372602155:web:ffc53d2494a3cb89a6236e",
  measurementId: "G-L73KVZTMVT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// state
let editMode = false;
const EDIT_PASSWORD = "900226";

// é–‹æ”¾æŸ¥è©¢æ™‚é–“ (å°ç£æ™‚å€ +08:00)
const openTime = new Date("2025-09-28T17:00:00+08:00");
const closeTime = new Date("2025-09-28T23:30:00+08:00");

function isWithinOpenTime(){
  const now = new Date();
  return now >= openTime && now <= closeTime;
}

function maskPhone(phone){
  if(!phone) return "";
  return phone.replace(/(\d{2})(\d+)(\d{2})/, (m,p1,p2,p3)=> p1 + "*".repeat(p2.length) + p3);
}

// update warning box text with formatted times
function updateTimeNotice(){
  document.getElementById("timeNotice").innerText =
    `æŸ¥è©¢é–‹æ”¾æ™‚é–“ï¼š${openTime.toLocaleString()} ~ ${closeTime.toLocaleString()}ã€€|ã€€çé …éœ€æ–¼æ™šæœƒæ´»å‹•æœŸé–“é ˜å–ï¼Œæ´»å‹•çµæŸå¾Œä¸è£œé ˜`;
}
updateTimeNotice();

// Toggle edit mode (requires password)
function toggleMode(){
  if(!editMode){
    const input = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
    if(input === EDIT_PASSWORD){
      editMode = true;
      document.getElementById("editCard").classList.remove("hidden");
      document.querySelectorAll(".adminCol").forEach(el=>el.classList.remove("hidden"));
      makeTableEditable(true);
      manualRefresh(); // show data immediately
      const hasRows = document.querySelectorAll("#lotteryTable tbody tr").length > 0;
      if(!hasRows) addRow();
    } else {
      alert("å¯†ç¢¼éŒ¯èª¤");
    }
  } else {
    editMode = false;
    document.getElementById("editCard").classList.add("hidden");
    document.getElementById("historyList").classList.add("hidden");
    document.querySelectorAll(".adminCol").forEach(el=>el.classList.add("hidden"));
    makeTableEditable(false);
    manualRefresh();
  }
}

function makeTableEditable(enable){
  document.querySelectorAll("#lotteryTable tbody tr").forEach(tr=>{
    tr.querySelectorAll("td.dataCell").forEach(td=>{
      td.contentEditable = enable;
      td.style.background = enable ? "#fffde7" : "";
    });
    // show/hide op cell
    const op = tr.querySelector("td.opCell");
    if(op) op.style.display = enable ? "" : "none";
  });
}

// Add a new editable row
function addRow(){
  const tbody = document.querySelector("#lotteryTable tbody");
  const row = tbody.insertRow();
  const cells = ["æ–°ä¸­çè™Ÿ","æ–°çå“","æ–°å¾—çäºº","æ–°é›»è©±"];
  cells.forEach(txt=>{
    const c = row.insertCell();
    c.className = "dataCell";
    c.innerText = txt;
    c.contentEditable = true;
    c.style.background = "#fffde7";
  });
  const op = row.insertCell();
  op.className = "opCell";
  op.innerHTML = '<button class="btn red" onclick="deleteRow(this)">åˆªé™¤</button>';
}

// Delete row (immediate on UI; saveData will persist change)
function deleteRow(btn){
  const row = btn.closest("tr");
  if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ä¸€ç­†ï¼Ÿ")) row.remove();
}

// Save current table => write to Firebase current and push to history
function saveData(){
  const data = [];
  document.querySelectorAll("#lotteryTable tbody tr").forEach(tr=>{
    const tds = tr.querySelectorAll("td.dataCell");
    if(tds.length<4) return;
    const obj = {
      number: (tds[0].innerText||"").trim(),
      item: (tds[1].innerText||"").trim(),
      winner: (tds[2].innerText||"").trim(),
      phone: (tds[3].innerText||"").trim()
    };
    if(obj.number || obj.item || obj.winner || obj.phone) data.push(obj);
  });
  if(data.length === 0){ alert("è³‡æ–™ä¸å¯ç‚ºç©º"); return; }
  const ts = Date.now();
  db.ref("/lottery/current").set({time: ts, data: data})
    .then(()=>{
      db.ref("/lottery/history").push({time: ts, data: data});
      alert("å·²å„²å­˜ä¸¦åŒæ­¥åˆ° Firebase");
      clearSearch();
    }).catch(err=>{
      console.error(err);
      alert("å„²å­˜å¤±æ•—ï¼š" + (err.message||err));
    });
}

// Show history list (last 50)
function showHistory(){
  const listEl = document.getElementById("historyList");
  listEl.innerHTML = "";
  db.ref("/lottery/history").limitToLast(50).once("value").then(snap=>{
    const val = snap.val();
    if(!val){ alert("æ²’æœ‰æ­·å²ç´€éŒ„"); return; }
    const arr = Object.keys(val).map(k=>({key:k, v: val[k]})).sort((a,b)=>b.v.time - a.v.time);
    arr.forEach(entry=>{
      const d = new Date(entry.v.time);
      const div = document.createElement("div");
      div.style.padding="8px";
      div.style.borderBottom="1px solid #eee";
      div.style.cursor="pointer";
      div.innerText = `${d.toLocaleString()} â€” ${entry.v.data.length} ç­†`;
      div.onclick = ()=> loadHistory(entry.v);
      listEl.appendChild(div);
    });
    listEl.classList.remove("hidden");
  }).catch(err=>{ console.error(err); alert("è®€å–æ­·å²å¤±æ•—"); });
}

// Load history (preview)
function loadHistory(h){
  renderTableFromData(h.data);
  alert(`å·²è¼‰å…¥ ${new Date(h.time).toLocaleString()} çš„è³‡æ–™ï¼ˆåƒ…é è¦½ï¼Œä¸æœƒè‡ªå‹•è¦†è“‹ï¼‰`);
  clearSearch();
}

// Render table from data array; masks phone for visitors
function renderTableFromData(data){
  const tbody = document.querySelector("#lotteryTable tbody");
  tbody.innerHTML = "";
  (data||[]).forEach(r=>{
    const row = tbody.insertRow();
    const c1 = row.insertCell(); c1.className = "dataCell"; c1.innerText = r.number || "";
    const c2 = row.insertCell(); c2.className = "dataCell"; c2.innerText = r.item || "";
    const c3 = row.insertCell(); c3.className = "dataCell"; c3.innerText = r.winner || "";
    const c4 = row.insertCell(); c4.className = "dataCell"; c4.innerText = editMode ? (r.phone||"") : maskPhone(r.phone||"");
    const op = row.insertCell(); op.className = "opCell"; op.innerHTML = '<button class="btn red" onclick="deleteRow(this)">åˆªé™¤</button>';
    if(!editMode) op.style.display = "none";
  });
  makeTableEditable(editMode);
}

// Search items (partial, case-insensitive) and highlight rows
function searchItems(){
  const q = (document.getElementById("searchInput").value||"").trim().toLowerCase();
  const rows = Array.from(document.querySelectorAll("#lotteryTable tbody tr"));
  let matches = 0;
  rows.forEach(r=> r.classList.remove("highlight"));
  if(q===""){
    document.getElementById("searchCount").innerText = "";
    rows.forEach(r=> r.style.display = "");
    return;
  }
  rows.forEach(r=>{
    const text = r.innerText.toLowerCase();
    if(text.includes(q)){
      r.style.display = "";
      r.classList.add("highlight");
      matches++;
    } else {
      r.style.display = "none";
    }
  });
  document.getElementById("searchCount").innerText = `æœå°‹ã€Œ${q}ã€çµæœï¼š ${matches} ç­†`;
  if(matches>0){
    const first = document.querySelector("#lotteryTable tbody tr:not([style*='display: none'])");
    if(first) first.scrollIntoView({behavior:"smooth", block:"center"});
  }
}

// Clear search
function clearSearch(){
  document.getElementById("searchInput").value = "";
  document.getElementById("searchCount").innerText = "";
  document.querySelectorAll("#lotteryTable tbody tr").forEach(r=>{ r.style.display=""; r.classList.remove("highlight"); });
}

// Manual refresh: fetch current snapshot once; enforce time restriction for visitors
function manualRefresh(){
  const now = new Date();
  if(!editMode && (now < openTime || now > closeTime)){
    // clear table and show notice in console; warning box remains visible
    renderTableFromData([]);
    document.getElementById("searchCount").innerText = now < openTime ? "â³ å°šæœªé–‹æ”¾æŸ¥è©¢" : "ğŸ”’ æŸ¥è©¢å·²æˆªæ­¢";
    return;
  }
  document.getElementById("searchCount").innerText = "";
  db.ref("/lottery/current").once("value").then(snap=>{
    const v = snap.val();
    if(v && v.data) renderTableFromData(v.data);
    clearSearch();
  });
}

// Realtime listener (respect view restrictions)
db.ref("/lottery/current").on("value", snap=>{
  const now = new Date();
  if(!editMode && (now < openTime || now > closeTime)){
    renderTableFromData([]);
    return;
  }
  const v = snap.val();
  if(v && v.data) renderTableFromData(v.data);
});

window.onload = function(){ manualRefresh(); };
</script>
</body>
</html>
